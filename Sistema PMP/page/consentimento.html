<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema PMP/PMAL | CONSENTIMENTO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/stylesindex.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/certidao.css">
    <link rel="stylesheet" href="/css/concentimento.css">

    <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>

<body>
    <header>
        <section class="cabecalho-geral"
            style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div class="header-info-left">
                <img class="brasao" src="/img/brasao.png" alt="brasao">
                <div class="cabecalho">
                    <h1>CENTRAL DE MONITORAMENTO ÍRIS</h1>
                    <h3>POLÍCIA MILITAR DE ALAGOAS</h3>
                    <h3>CENTRAL DE OPERAÇÕES DA POLÍCIA MILITAR - COPOM</h3>
                    <h3 id="unidade">--</h3>
                </div>
            </div>
            <div class="header-info-right" style="text-align: right; padding-right: 50px;">
                <div style="color: blueviolet; font-weight: bold;"><i class="fas fa-user-shield"></i> Operador: <span
                        id="nome-operador">---</span></div>
                <div id="relogio" style="color: #555; font-weight: bold; font-size: 1.1rem;"><span
                        id="current-date-time"></span></div>
            </div>
        </section>
    </header>
    <section class="pagecomplete">
        <nav class="navegacao">
            <div class="nav-links">
                <a href="index.html">
                    <img width="30" height="30" src="https://img.icons8.com/material-outlined/24/home--v2.png"
                        alt="home" />
                    <p>Home</p>
                </a>
                <a href="fiscalizacaohome.html" class="active">
                    <img width="30" height="30" src="https://img.icons8.com/ios-filled/50/policeman-female.png"
                        alt="policeman-female" />
                    <p>Fiscalização</p>
                </a>
            </div>

            <a href="javascript:void(0)" onclick="logout()"
                style="color: #d9534f; border-top: 1px solid #eee; padding-top: 15px;">
                <i class="fas fa-sign-out-alt" style="font-size: 24px;"></i>
                <p>Sair</p>
            </a>
        </nav>

        <div class="container-tabela">
            <div class="header-tabela">
                <h2 style="color: blueviolet;"><i style="color: blueviolet;" class="fas fa-file-invoice"></i> Termos de
                    Consentimento</h2>
                <button class="btn-adicionar" onclick="abrirSidebarCertidao()">
                    <i class="fas fa-plus"></i> Novo Termo de Consentimento
                </button>
            </div>
            <div class="barra-filtros">
                <div style="flex: 1; min-width: 200px;">
                    <input class="filtro" type="text" id="filtro-nome" placeholder="Filtrar por Assistida..."
                        onkeyup="filtrarTabela()">
                </div>
                <input class="filtrodata" type="date" id="filtro-data" onchange="filtrarTabela()">
                <button class="btn-adicionar" onclick="abrirModalRelatorio()"
                    style="background-color: #2c3e50; margin-left: auto;">
                    <i class="fas fa-print"></i> Relatório Mensal
                </button>
            </div>

            <div id="modal-relatorio" class="sidebar-cadastro"
                style="display:none; background: rgba(0,0,0,0.5); width: 100%; height: 100%; justify-content: center; align-items: center;">
                <div style="background: white; padding: 30px; border-radius: 8px; width: 400px; position: relative;">
                    <h3>Gerar Relatório Mensal</h3>
                    <br>
                    <label>Data Início:</label>
                    <input type="date" id="rel-inicio" class="grupo-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Data Fim:</label>
                    <input type="date" id="rel-fim" class="grupo-input" style="width: 100%; margin-bottom: 10px;">
                    <label>Vara:</label>
                    <input type="text" id="rel-vara" placeholder="Ex: 1ª VARA"
                        style="width: 100%; margin-bottom: 20px; padding: 8px;">

                    <div style="display: flex; gap: 10px;">
                        <button onclick="gerarRelatorioMensal()" class="btn-salvar">Gerar Relatório</button>
                        <button onclick="fecharModalRelatorio()"
                            style="background:#666; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Cancelar</button>
                    </div>
                </div>
            </div>
            <div class="tabela-wrapper">
                <table class="tabela-assistidas">
                    <thead>
                        <tr>
                            <th>DATA</th>
                            <th>REPRESENTANTE</th>
                            <th>MPU</th>
                            <th>VARA</th>
                            <th>STATUS</th>
                            <th style="text-align: center;">AÇÕES</th>
                        </tr>
                    </thead>
                    <tbody id="corpo-tabela-certidoes">
                    </tbody>
                </table>
            </div>
        </div>

        <div id="sidebar-certidao" class="sidebar-certidao">
            <div class="sidebar-content">
                <div class="sidebar-header">
                    <h2 id="titulo-sidebar">Nova Certidão</h2>
                    <button onclick="fecharSidebarCertidao()" class="btn-fechar-sidebar">&times;</button>
                </div>

                <form id="form-certidao">
                    <input type="hidden" id="ID">
                    <div class="grupo-input">
                        <label>Data</label>
                        <input type="date" id="DATA" required>
                    </div>

                    <div class="grupo-input">
                        <label for="NOME">Nome da Assistida:</label>
                        <select name="NOME" id="NOME" required>
                            <option value="">Carregando assistidas...</option>
                        </select>
                    </div>

                    <div class="row-form" style="display:flex; gap:10px;">
                        <div class="grupo-input" style="flex:1;">
                            <label>RG</label>
                            <input type="text" id="RG">
                        </div>
                        <div class="grupo-input" style="flex:1;">
                            <label>CPF</label>
                            <input type="text" id="CPF">
                        </div>
                    </div>

                    <div class="row-form" style="display:flex; gap:10px;">
                        <div class="grupo-input" style="flex:1;">
                            <label>MÃE</label>
                            <input type="text" id="MÃE">
                        </div>
                        <div class="grupo-input" style="flex:1;">
                            <label>PAI</label>
                            <input type="text" id="PAI">
                        </div>
                    </div>

                    <div class="grupo-input">
                        <label>DATA DE NASCIMENTO</label>
                        <input type="date" id="DATA_DE_NASCIMENTO">
                    </div>

                    <div class="row-form" style="display:flex; gap:10px;">
                        <div class="grupo-input" style="flex:1;">
                            <label>VARA</label>
                            <input type="text" id="VARA">
                        </div>
                        <div class="grupo-input" style="flex:1;">
                            <label>MPU</label>
                            <input type="text" id="MPU">
                        </div>
                    </div>

                    <div class="grupo-input">
                        <label>STATUS</label>
                        <input type="text" id="STATUS">
                    </div>

                    <div class="campo" style="flex: 1 1 100%;">
                        <label>Assinatura da Assistida:</label>
                        <div style="border: 2px dashed #ccc; background: #fff; position: relative;">
                            <canvas id="canvas-assinatura" width="700" height="250"
                                style="cursor: crosshair; width: 100%;"></canvas>
                            <div style="margin-top: 5px;">
                                <button type="button" onclick="limparAssinatura()" class="btn-limpar">Limpar</button>
                                <button type="button" id="btn-travar" onclick="alternarTravaCanvas()"
                                    class="btn-travar">Bloquear Assinatura</button>
                            </div>
                        </div>
                    </div>

                    <div class="botoes-form" style="margin-top: 20px;">
                        <button type="submit" class="btn-salvar" style="width: 100%; padding: 15px; font-weight: bold;">
                            <i class="fas fa-save"></i> SALVAR TERMO DE CONSENTIMENTO
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <footer>
        <h4>Seção de Planejamento, Instrução e Estatística - P3/10ºBPM</h4>
        <h4>Patrulha Maria da Penha - 10ºBPM</h4>
    </footer>

    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            databaseURL: "https://botpanico-6346c-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const sidebar = document.getElementById('sidebar-certidao');

        function abrirSidebarCertidao() {
            if (sidebar) {
                sidebar.classList.add('active'); // Isso faz o menu aparecer
                console.log("Sidebar aberto");

                // Limpezas necessárias ao abrir novo
                limparAssinatura();
                const idCampo = document.getElementById('id_certidao');
                if (idCampo) idCampo.value = "";

                const form = document.getElementById('form-certidao');
                if (form) form.reset();
            } else {
                console.error("Erro: Elemento 'sidebar-certidao' não encontrado no HTML.");
            }
        }

        function fecharSidebarCertidao() {
            if (sidebar) {
                sidebar.classList.remove('active'); // Isso faz o menu sumir
            }
        }

        // --- VARIÁVEIS DO CANVAS (ASSINATURA) ---
        const canvas = document.getElementById('canvas-assinatura');
        const ctx = canvas ? canvas.getContext('2d') : null;
        let desenhando = false;
        let canvasTravado = false;

        if (canvas && ctx) {
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', iniciarDesenho);
            canvas.addEventListener('mousemove', desenhar);
            canvas.addEventListener('mouseup', pararDesenho);
            canvas.addEventListener('touchstart', iniciarDesenho);
            canvas.addEventListener('touchmove', desenhar);
            canvas.addEventListener('touchend', pararDesenho);
        }

        function obterPosicao(e) {
            const rect = canvas.getBoundingClientRect();

            // Calcula a escala entre o tamanho do elemento e o tamanho interno do canvas
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            return {
                // Ajusta a posição exata baseada na escala
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }
        function iniciarDesenho(e) {
            if (canvasTravado) return;
            desenhando = true;
            const pos = obterPosicao(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function desenhar(e) {
            if (!desenhando || canvasTravado) return;
            e.preventDefault();
            const pos = obterPosicao(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function pararDesenho() { desenhando = false; }

        function limparAssinatura() {
            if (ctx) ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function alternarTravaCanvas() {
            canvasTravado = !canvasTravado;
            const btn = document.getElementById('btn-travar');
            if (canvasTravado) {
                canvas.style.backgroundColor = "#f0f0f0";
                btn.innerHTML = '<i class="fas fa-lock"></i> Desbloquear';
                btn.style.backgroundColor = "#e74c3c";
            } else {
                canvas.style.backgroundColor = "#fff";
                btn.innerHTML = '<i class="fas fa-unlock"></i> Bloquear';
                btn.style.backgroundColor = "#2c3e50";
            }
        }

        // --- CRUD: SALVAR / ATUALIZAR ---
        const formConsentimento = document.getElementById('form-certidao');
        if (formConsentimento) {
            formConsentimento.addEventListener('submit', (e) => {
                e.preventDefault();

                const idExistente = document.getElementById('id_certidao').value;
                const idFinal = idExistente || db.ref('TermoConsentimento').push().key;

                const formData = new FormData(formConsentimento);
                const dados = {};

                formData.forEach((value, key) => {
                    if (key !== "id_certidao") dados[key] = value;
                });

                // Captura a assinatura do Canvas
                dados["ASSINATURA_BASE64"] = canvas.toDataURL();
                dados["OPERADOR"] = localStorage.getItem('usuarioNome');
                dados["UNIDADE"] = localStorage.getItem('usuarioUnidade');
                dados["DATA_SISTEMA"] = new Date().toLocaleString('pt-BR');

                db.ref('TermoConsentimento').child(idFinal).set(dados, (error) => {
                    if (error) {
                        alert("Erro ao salvar!");
                    } else {
                        alert("Salvo com sucesso!");
                        fecharSidebar(); // AGORA A FUNÇÃO EXISTE COM ESSE NOME
                        formConsentimento.reset();
                        limparAssinatura();
                        carregarTabela();
                    }
                });
            });
        }

        // --- CRUD: EDITAR (RECUPERAR DADOS) ---
        function preencherParaEditar(id) {
            db.ref('TermoConsentimento').child(id).once('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                abrirSidebar(); // AGORA A FUNÇÃO EXISTE COM ESSE NOME
                document.getElementById('id_certidao').value = id;

                Object.keys(data).forEach(key => {
                    const input = document.getElementsByName(key)[0];
                    if (input) input.value = data[key];
                });

                if (data.ASSINATURA_BASE64) {
                    const img = new Image();
                    img.onload = () => {
                        limparAssinatura();
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = data.ASSINATURA_BASE64;
                }
            });
        }

        // --- CARREGAR TABELA ---
        function carregarTabela() {
            const tbody = document.getElementById('corpo-tabela-certidoes');
            if (!tbody) return;

            db.ref('assistidas').once('value', (snapAssist) => {
                const assistMap = {};
                snapAssist.forEach(a => { assistMap[a.key] = a.val().NOME; });

                db.ref('TermoConsentimento').on('value', (snapshot) => {
                    tbody.innerHTML = "";
                    snapshot.forEach((child) => {
                        const c = child.val();
                        // Ajuste: Busca o nome usando a chave salva no campo NOME ou nome_representante
                        const nomeKey = c.NOME || c.nome_representante;
                        const nomeDisplay = assistMap[nomeKey] || nomeKey || "N/D";

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                        <td>${c.DATA || '-'}</td>
                        <td><b>${nomeDisplay}</b></td>
                        <td>${c.MPU || '-'}</td>
                        <td>${c.VARA || '-'}</td>
                        <td>${c.STATUS || 'PENDENTE'}</td>
                        <td>
                            <button class="btn-edit-tabela" onclick="preencherParaEditar('${child.key}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                        tbody.appendChild(tr);
                    });
                });
            });
        }

        // --- INICIALIZAÇÃO ---
        function popularSelectAssistidas() {
            // Buscamos o elemento pelo ID 'NOME' que acabamos de ajustar
            const select = document.getElementById('NOME');
            if (!select) return;

            // Acessa o nó 'assistidas' no Firebase
            db.ref('assistidas').once('value', (snapshot) => {
                // Limpa o select e adiciona a opção inicial
                select.innerHTML = '<option value="">Selecione a Assistida...</option>';

                const assistidas = [];

                snapshot.forEach((child) => {
                    const dados = child.val();
                    assistidas.push({
                        id: child.key,
                        nome: dados.NOME || "Sem Nome"
                    });
                });

                // Ordena por ordem alfabética para facilitar a busca
                assistidas.sort((a, b) => a.nome.localeCompare(b.nome));

                // Adiciona as opções ao select
                assistidas.forEach((assistida) => {
                    const opt = document.createElement('option');
                    opt.value = assistida.id; // O valor enviado será o ID (chave) do Firebase
                    opt.textContent = assistida.nome;
                    select.appendChild(opt);
                });
            });
        }
        // --- RELATÓRIO MENSAL --- 

        function abrirModalRelatorio() {
            document.getElementById('modal-relatorio').style.display = 'flex';
        }

        function fecharModalRelatorio() {
            document.getElementById('modal-relatorio').style.display = 'none';
        }

        function gerarRelatorioMensal() {
            const elInicio = document.getElementById('rel-inicio');
            const elFim = document.getElementById('rel-fim');
            const elVara = document.getElementById('rel-vara');

            if (!elInicio || !elFim) return;

            const inicio = elInicio.value;
            const fim = elFim.value;
            const varaFiltro = elVara ? elVara.value : "";

            if (!inicio || !fim) {
                alert("Por favor, selecione o período.");
                return;
            }

            const prepararDataParaComparar = (dataBr) => {
                if (!dataBr || !dataBr.includes('/')) return "";
                const partes = dataBr.split('/');
                return `${partes[2]}-${partes[1]}-${partes[0]}`;
            };

            db.ref('assistidas').once('value', (snapAssistidas) => {
                const assistMap = {};
                snapAssistidas.forEach(child => { assistMap[child.key] = child.val().NOME; });

                db.ref('TermoConsentimento').once('value', (snapshot) => {
                    const dadosFiltrados = [];

                    snapshot.forEach((child) => {
                        const c = child.val();
                        const dataComp = prepararDataParaComparar(c.DATA);

                        if (dataComp >= inicio && dataComp <= fim) {
                            const varaC = c.VARA || "";
                            if (varaFiltro === "" || varaC.includes(varaFiltro)) {
                                // Enviando apenas os 4 campos solicitados
                                dadosFiltrados.push({
                                    data: c.DATA || "-",
                                    assistida: assistMap[c.NOME] || c.NOME || "N/D",
                                    vara: c.VARA || "-",
                                    mpu: c.MPU || "-"
                                });
                            }
                        }
                    });

                    if (dadosFiltrados.length === 0) {
                        alert("Nenhum registro encontrado.");
                        return;
                    }

                    const infoRelatorio = {
                        periodo: `${inicio.split('-').reverse().join('/')} a ${fim.split('-').reverse().join('/')}`,
                        vara: varaFiltro || "TODAS",
                        unidade: localStorage.getItem('usuarioUnidade') || "PMAL",
                        operador: localStorage.getItem('usuarioNome') || "Operador",
                        dados: dadosFiltrados
                    };

                    localStorage.setItem('dadosRelatorioMensal', JSON.stringify(infoRelatorio));
                    // Abre o arquivo específico solicitado
                    window.open('/relatorios/relatorio_concentimento.html', '_blank');
                });
            });
        }

        function inicializarSistema() {
            const elUnidade = document.getElementById('unidade');
            const elNome = document.getElementById('nome-operador');
            const elRelogio = document.getElementById('current-date-time');

            if (elUnidade) elUnidade.innerText = localStorage.getItem('usuarioUnidade') || "PMAL";
            if (elNome) elNome.innerText = localStorage.getItem('usuarioNome') || "Operador";

            if (elRelogio) {
                setInterval(() => {
                    const agora = new Date();
                    elRelogio.innerText = agora.toLocaleDateString('pt-BR') + " | " + agora.toLocaleTimeString('pt-BR');
                }, 1000);
            }

            popularSelectAssistidas();
            carregarTabela();
        }

        window.onload = inicializarSistema;
    </script>
</body>

</html>